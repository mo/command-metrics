<!doctype>
<html>
<head>
<meta charset="utf-8">

<link type="text/css" rel="stylesheet" href="../../thirdparty/rickshaw.css">
<script src="../../thirdparty/d3.v3.js"></script>
<script src="../../thirdparty/d3.layout.min.js"></script>
<script src="../../thirdparty/rickshaw.js"></script>
<link rel="stylesheet" href="../../thirdparty/jquery-ui/jquery-ui-1.11.2/jquery-ui.min.css">
<script src="../../thirdparty/jquery-ui/jquery-ui-1.11.2/external/jquery/jquery.js"></script>
<script src="../../thirdparty/jquery-ui/jquery-ui-1.11.2/jquery-ui.min.js"></script>

<script src="../../thirdparty/analysis-chart/analysis-chart.js"></script>
<link type="text/css" rel="stylesheet" href="../../thirdparty/analysis-chart/analysis-chart.css">

<script src="utilities.js"></script>
<script src="../../../allChartData.js"></script>
<script src="command-metrics.js"></script>
<style>
#chart-select {
    font-size: 12pt;
    margin-bottom: 15px;
    margin-left: 100px;
    min-width: 1100px;
}
@font-face {
  font-family: "OpenSans";
  src: url("../../thirdparty/OpenSans-Regular.ttf");
}
body {
    font-family: OpenSans;
}
</style>
</head>
<body>

<select id="chart-select" onchange="javascript:window.location='?chart='+this.value">
</select>

<div id="analysis-chart-placeholder"></div>

<script>
var params = getUrlParams();

var selectedChart;
for (var i = 0; i < allChartData.length; ++i) {
    if (params["chart"] === allChartData[i]["chartKey"]) {
        selectedChart = allChartData[i];
        break;
    }
}
if (!selectedChart) {
    selectedChart = allChartData[0];
}

populateSelectBox(allChartData, selectedChart);

selectedChart.chartSeries = selectedChart.chartSeries.filter((serie) => {
    if (serie.data.length == 0) {
        console.warn(`WARNING: serie with name "${serie.name}" has empty data array, it will be ignored.`);
        return false;
    }
    return true;
})

const allSeries = selectedChart.chartSeries;
const allSeriesYMin = d3.min(allSeries, serie => d3.min(serie.data, datapoint => datapoint.y));
const allSeriesYMax = d3.max(allSeries, serie => d3.max(serie.data, datapoint => datapoint.y));
const allSeriesYSpan = allSeriesYMax - allSeriesYMin;

const agElement = document.querySelector('#analysis-chart-placeholder');
const analysisChart = new AnalysisChart({
    element: agElement,
    series: allSeries,
    rightColumnWidth: 300,
    width: window.innerWidth - 300,
    height: window.innerHeight - 300,
    xFormatter: (x) => AnalysisChart.timestampToDatetimeString(x),
    annotations: selectedChart.chartAnnotations
});

analysisChart.onYAxisScalingChanged((newMode) => {
    // TODO: save in url?
});

</script>
</body>
</html>
